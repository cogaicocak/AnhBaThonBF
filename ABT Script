local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local Plr = Players.LocalPlayer
local Chr = Plr.Character or Plr.CharacterAdded:Wait()
local HRP = Chr:WaitForChild("HumanoidRootPart")

-- Settings
local Settings = {
    AttackDelay = 0.1,
    BringDistance = 350,
    GroupRadius = 15,
    UpdateRate = 0.1
}

-- GUI Setup (giữ nguyên phần GUI như cũ)
-- ...

-- Tìm điểm trung tâm của các quái
local function GetMobsCenter(enemies)
    local center = Vector3.new(0, 0, 0)
    local count = 0
    
    for _, enemy in pairs(enemies) do
        if enemy.HumanoidRootPart then
            center = center + enemy.HumanoidRootPart.Position
            count = count + 1
        end
    end
    
    if count > 0 then
        return center / count
    end
    return nil
end

-- Get nearby enemies function
local function GetNearbyEnemies(questMob)
    local enemies = {}
    for _, enemy in pairs(workspace.Enemies:GetChildren()) do
        if enemy:FindFirstChild("Humanoid") 
        and enemy:FindFirstChild("HumanoidRootPart") 
        and enemy.Humanoid.Health > 0 
        and enemy.Name == questMob then
            local distance = (enemy.HumanoidRootPart.Position - HRP.Position).Magnitude
            if distance <= Settings.BringDistance then
                table.insert(enemies, enemy)
            end
        end
    end
    return enemies
end

-- Function to equip Combat
local function EquipCombat()
    local Combat = Plr.Backpack:FindFirstChild("Combat") or Chr:FindFirstChild("Combat")
    if Combat and not Chr:FindFirstChild("Combat") then
        Combat.Parent = Chr
    end
end

-- Attack function
local function PerformAttack()
    EquipCombat()
    local Combat = Chr:FindFirstChild("Combat")
    if Combat then
        Combat:Activate()
    end
end

local LastAttackTime = 0

local function StartFarm()
    local Connection
    Connection = RunService.Heartbeat:Connect(function()
        if not Farming then 
            Connection:Disconnect()
            return 
        end
        
        pcall(function()
            local Q = GetQuest()
            
            -- Get Quest if needed
            if not Plr.PlayerGui.Main.Quest.Visible then
                UpdateStatus("Getting Quest...")
                HRP.CFrame = Q.Pos
                task.wait(0.3)
                CommF:InvokeServer("StartQuest", Q.Name, Q.QLv)
                task.wait(0.3)
            end
            
            -- Get nearby enemies
            local enemies = GetNearbyEnemies(Q.Mon)
            
            if #enemies > 0 then
                UpdateStatus("Fighting: " .. #enemies .. " enemies")
                
                -- Tìm điểm trung tâm của quái
                local mobsCenter = GetMobsCenter(enemies)
                if mobsCenter then
                    -- Teleport người chơi đến trung tâm của quái
                    HRP.CFrame = CFrame.new(mobsCenter + Vector3.new(0, 10, 0))
                    
                    -- Bring all enemies
                    for _, enemy in pairs(enemies) do
                        if enemy.HumanoidRootPart then
                            -- Bring quái đến dưới người chơi
                            enemy.HumanoidRootPart.CFrame = CFrame.new(mobsCenter + Vector3.new(0, -5, 0))
                            enemy.HumanoidRootPart.Velocity = Vector3.new(0, 0, 0)
                            enemy.HumanoidRootPart.CanCollide = false
                            
                            -- Disable enemy movement
                            if enemy.Humanoid then
                                enemy.Humanoid.PlatformStand = true
                                enemy.Humanoid.WalkSpeed = 0
                                enemy.Humanoid.JumpPower = 0
                            end
                        end
                    end
                    
                    -- Attack with cooldown
                    local currentTime = tick()
                    if currentTime - LastAttackTime >= Settings.AttackDelay then
                        PerformAttack()
                        LastAttackTime = currentTime
                    end
                end
            else
                UpdateStatus("Searching for mobs...")
                -- Di chuyển đến khu vực quái spawn
                local spawnPos = Q.Pos.Position
                HRP.CFrame = CFrame.new(spawnPos + Vector3.new(0, 10, 0))
            end
        end)
    end)
end

Button.MouseButton1Click:Connect(function()
    Farming = not Farming
    if Farming then
        Button.Text = "Stop Farm"
        Button.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
        StartFarm()
    else
        Button.Text = "Start Farm"
        Button.BackgroundColor3 = Color3.fromRGB(0, 255, 0)
        UpdateStatus("Stopped")
    end
end)

UpdateStatus("Ready to farm")
print(string.format("[%s] Started farming script for: %s", os.date("%Y-%m-%d %H:%M:%S"), Plr.Name))
print("Current Level:", Plr.Data.Level.Value)
print("Current Quest:", GetQuest().Name)
print("Target Monster:", GetQuest().Mon)
