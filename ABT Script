local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

-- Variables
local Plr = Players.LocalPlayer
local Chr = Plr.Character or Plr.CharacterAdded:Wait()
local HRP = Chr:WaitForChild("HumanoidRootPart")

-- Remote paths
local CommF = ReplicatedStorage.Remotes.CommF_
local RegisterHit = ReplicatedStorage.Modules.Net:FindFirstChild("RE/RegisterHit")
local RegisterAttack = ReplicatedStorage.Modules.Net:FindFirstChild("RE/RegisterAttack")

-- Settings
local Settings = {
    AttackDelay = 0.1,
    BringDistance = 350,
    GroupRadius = 15,
    UpdateRate = 0.1
}

-- GUI Setup
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Parent = Plr:WaitForChild("PlayerGui")

local Button = Instance.new("TextButton")
Button.Size = UDim2.new(0, 100, 0, 50)
Button.Position = UDim2.new(0.1, 0, 0.8, 0)
Button.BackgroundColor3 = Color3.fromRGB(0, 255, 0)
Button.Text = "Start Farm"
Button.TextColor3 = Color3.fromRGB(255, 255, 255)
Button.Font = Enum.Font.SourceSansBold
Button.TextSize = 20
Button.Parent = ScreenGui

local Status = Instance.new("TextLabel")
Status.Size = UDim2.new(0, 200, 0, 30)
Status.Position = UDim2.new(0.1, 0, 0.7, 0)
Status.BackgroundTransparency = 1
Status.Text = "Status: Waiting..."
Status.TextColor3 = Color3.fromRGB(255, 255, 255)
Status.Font = Enum.Font.SourceSansBold
Status.TextSize = 16
Status.Parent = ScreenGui

local Farming = false

local Quests = {
    {Lv = 1, Name = "BanditQuest1", QLv = 1, Mon = "Bandit [Lv. 5]", Pos = CFrame.new(1060, 17, 1547)},
    {Lv = 10, Name = "JungleQuest", QLv = 1, Mon = "Monkey [Lv. 14]", Pos = CFrame.new(-1598, 37, 153)},
    {Lv = 30, Name = "BuggyQuest1", QLv = 1, Mon = "Pirate [Lv. 16]", Pos = CFrame.new(-1140, 5, 3828)},
    {Lv = 30, Name = "BuggyQuest1", QLv = 2, Mon = "Strong Pirate [Lv. 35]", Pos = CFrame.new(-1140, 5, 3828)},
    {Lv = 40, Name = "DesertQuest", QLv = 1, Mon = "Desert Bandit [Lv. 45]", Pos = CFrame.new(897, 7, 4388)},
    {Lv = 60, Name = "DesertQuest", QLv = 2, Mon = "Desert Officer [Lv. 70]", Pos = CFrame.new(897, 7, 4388)},
    {Lv = 75, Name = "SnowQuest", QLv = 1, Mon = "Snow Bandit [Lv. 90]", Pos = CFrame.new(1389, 87, -1298)}
}

local function GetQuest()
    local Lv = Plr.Data.Level.Value
    local Q = Quests[1]
    for _,v in ipairs(Quests) do
        if Lv >= v.Lv then Q = v else break end
    end
    return Q
end

local function UpdateStatus(text)
    if Status then
        Status.Text = "Status: " .. text
    end
end

-- Get nearby enemies function
local function GetNearbyEnemies(questMob)
    local enemies = {}
    for _, enemy in pairs(workspace.Enemies:GetChildren()) do
        if enemy:FindFirstChild("Humanoid") 
        and enemy:FindFirstChild("HumanoidRootPart") 
        and enemy.Humanoid.Health > 0 
        and enemy.Name == questMob then
            local distance = (enemy.HumanoidRootPart.Position - HRP.Position).Magnitude
            if distance <= Settings.BringDistance then
                table.insert(enemies, enemy)
            end
        end
    end
    return enemies
end

-- Function to equip Combat
local function EquipCombat()
    local Combat = Plr.Backpack:FindFirstChild("Combat") or Chr:FindFirstChild("Combat")
    if Combat and not Chr:FindFirstChild("Combat") then
        Combat.Parent = Chr
    end
end

-- Modified Attack function to use Combat
local function PerformAttack()
    EquipCombat() -- Make sure Combat is equipped
    local Combat = Chr:FindFirstChild("Combat")
    if Combat then
        Combat:Activate()
    end
end

local LastAttackTime = 0

local function StartFarm()
    local CenterPosition = nil
    
    local Connection
    Connection = RunService.Heartbeat:Connect(function()
        if not Farming then 
            Connection:Disconnect()
            return 
        end
        
        pcall(function()
            local Q = GetQuest()
            
            -- Get Quest if needed
            if not Plr.PlayerGui.Main.Quest.Visible then
                UpdateStatus("Getting Quest...")
                HRP.CFrame = Q.Pos
                task.wait(0.3)
                CommF:InvokeServer("StartQuest", Q.Name, Q.QLv)
                task.wait(0.3)
                CenterPosition = Q.Pos.Position
            end
            
            -- Set initial center position if not set
            if not CenterPosition then
                CenterPosition = Q.Pos.Position
            end
            
            -- Get nearby enemies
            local enemies = GetNearbyEnemies(Q.Mon)
            
            if #enemies > 0 then
                UpdateStatus("Fighting: " .. #enemies .. " enemies")
                
                -- Bring all enemies
                for _, enemy in pairs(enemies) do
                    if enemy.HumanoidRootPart then
                        -- Set enemy position below player
                        enemy.HumanoidRootPart.CFrame = CFrame.new(CenterPosition + Vector3.new(0, -5, 0))
                        enemy.HumanoidRootPart.Velocity = Vector3.new(0, 0, 0)
                        enemy.HumanoidRootPart.CanCollide = false
                        
                        -- Disable enemy movement
                        if enemy.Humanoid then
                            enemy.Humanoid.PlatformStand = true
                            enemy.Humanoid.WalkSpeed = 0
                            enemy.Humanoid.JumpPower = 0
                        end
                    end
                end
                
                -- Position player above enemies
                HRP.CFrame = CFrame.new(CenterPosition + Vector3.new(0, 10, 0))
                
                -- Attack with cooldown
                local currentTime = tick()
                if currentTime - LastAttackTime >= Settings.AttackDelay then
                    PerformAttack()
                    LastAttackTime = currentTime
                end
            else
                UpdateStatus("Waiting for mobs...")
                HRP.CFrame = CFrame.new(CenterPosition + Vector3.new(0, 10, 0))
            end
        end)
    end)
end

Button.MouseButton1Click:Connect(function()
    Farming = not Farming
    if Farming then
        Button.Text = "Stop Farm"
        Button.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
        StartFarm()
    else
        Button.Text = "Start Farm"
        Button.BackgroundColor3 = Color3.fromRGB(0, 255, 0)
        UpdateStatus("Stopped")
    end
end)

UpdateStatus("Ready to farm")
print(string.format("[%s] Started farming script for: %s", os.date("%Y-%m-%d %H:%M:%S"), Plr.Name))
print("Current Level:", Plr.Data.Level.Value)
print("Current Quest:", GetQuest().Name)
print("Target Monster:", GetQuest().Mon)
